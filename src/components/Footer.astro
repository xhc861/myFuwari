---
import { profileConfig } from "../config";
import { url } from "../utils/url-utils";

const currentYear = new Date().getFullYear();
const launchDate = new Date("2026-01-02");
const today = new Date();
const daysRunning = Math.floor(
	(today.getTime() - launchDate.getTime()) / (1000 * 60 * 60 * 24),
);

let dailyQuote = "愿你眼中总有光芒，活成你想要的模样。";

// 尝试从每日一言API获取句子（仅在生产环境）
if (import.meta.env.PROD) {
	try {
		const controller = new AbortController();
		const timeoutId = setTimeout(() => controller.abort(), 3000); // 3秒超时
		
		const res = await fetch("https://v1.hitokoto.cn?c=i&encode=json", {
			signal: controller.signal
		});
		clearTimeout(timeoutId);
		
		if (res.ok) {
			const data = await res.json();
			if (data?.hitokoto) {
				dailyQuote = `"${data.hitokoto}" — ${data.from || "佚名"}`;
			}
		}
	} catch (e) {
		// 构建时 API 调用失败是正常的，客户端会重新获取
	}
}
---

<div class="transition border-t border-black/10 dark:border-white/15 my-10 border-dashed mx-32"></div>

<div class="transition border-dashed border-[oklch(85%_0.01_var(--hue))] dark:border-white/15 rounded-2xl mb-12 flex flex-col items-center justify-center px-6 space-y-4 text-center">
    <!-- 每日一言 -->
    <div id="daily-quote" class="text-sm italic text-gray-600 dark:text-gray-400">
        {dailyQuote}
    </div>

    <!-- 安全运行天数 -->
    <div class="text-xs text-gray-500 dark:text-gray-400">
        本网站已安全运行 <span id="run-days">{daysRunning}</span> 天
    </div>
<div class="text-xs text-gray-500 dark:text-gray-400">
  Ciallo～(∠・ω&lt; )⌒☆
</div>


    <!-- 底部信息 -->
    <div class="transition text-50 text-sm text-center">
        &copy; <span id="copyright-year">{currentYear}</span> {profileConfig.name}. All Rights Reserved. /
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href={url('rss.xml')}>RSS</a> /
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href={url('sitemap-index.xml')}>Sitemap</a><br>
        本网站使用
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://astro.build">Astro</a> 和
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://github.com/saicaca/fuwari">Fuwari</a>
        项目并二次开发
    </div>
</div>

<script>
  // 客户端脚本 - 动态更新运行时间和诗句
  // 这个脚本在客户端执行，确保每次访问都能获取最新数据
  
  function updateFooter() {
    // 更新运行时间
    const launchDate = new Date("2026-01-02");
    const today = new Date();
    const daysRunning = Math.floor((today.getTime() - launchDate.getTime()) / (1000 * 60 * 60 * 24));
    const runDaysElement = document.getElementById('run-days');
    if (runDaysElement) {
      runDaysElement.textContent = String(daysRunning);
    }

    // 获取每日一言（带超时和重试）
    const fetchHitokoto = async (retries = 2) => {
      for (let i = 0; i < retries; i++) {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 5000); // 5秒超时
          
          const res = await fetch("https://v1.hitokoto.cn?c=i&encode=json", {
            signal: controller.signal
          });
          clearTimeout(timeoutId);
          
          if (!res.ok) throw new Error('API request failed');
          const data = await res.json();
          
          if (data && data.hitokoto) {
            const dailyQuoteElement = document.getElementById('daily-quote');
            if (dailyQuoteElement) {
              dailyQuoteElement.textContent = `"${data.hitokoto}" — ${data.from || "佚名"}`;
            }
          }
          return; // 成功则退出
        } catch (e) {
          if (i === retries - 1) {
            // 最后一次重试失败，保持默认值
            console.info("每日一言暂时无法获取，显示默认句子");
          } else {
            // 等待后重试
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }
      }
    };
    
    fetchHitokoto();
  }

  // 页面加载完成后执行
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', updateFooter);
  } else {
    updateFooter();
  }

  // 可选：定期刷新运行时间（每分钟更新一次）
  setInterval(() => {
    const launchDate = new Date("2026-01-02");
    const today = new Date();
    const daysRunning = Math.floor((today.getTime() - launchDate.getTime()) / (1000 * 60 * 60 * 24));
    const runDaysElement = document.getElementById('run-days');
    if (runDaysElement) {
      runDaysElement.textContent = String(daysRunning);
    }
  }, 60000); // 每60秒更新一次
</script>
