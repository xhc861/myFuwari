---
import { profileConfig } from "../config";
import { url } from "../utils/url-utils";

const currentYear = new Date().getFullYear();
const launchDate = new Date("2026-01-02");
const today = new Date();
const daysRunning = Math.floor(
	(today.getTime() - launchDate.getTime()) / (1000 * 60 * 60 * 24),
);

// 默认一言句子
const dailyQuote = "愿你眼中总有光芒，活成你想要的模样。";
---

<div class="transition border-t border-black/10 dark:border-white/15 my-10 border-dashed mx-32"></div>

<div class="transition border-dashed border-[oklch(85%_0.01_var(--hue))] dark:border-white/15 rounded-2xl mb-12 flex flex-col items-center justify-center px-6 space-y-4 text-center">
    <!-- 每日一言 -->
    <div id="daily-quote" class="text-sm italic text-gray-600 dark:text-gray-400" data-default-quote={dailyQuote}>
        {dailyQuote}
    </div>

    <!-- 安全运行天数 -->
    <div class="text-xs text-gray-500 dark:text-gray-400">
        本网站已安全运行 <span id="run-days">{daysRunning}</span> 天
    </div>
<div class="text-xs text-gray-500 dark:text-gray-400">
  Ciallo～(∠・ω&lt; )⌒☆
</div>


    <!-- 底部信息 -->
    <div class="transition text-50 text-sm text-center">
        &copy; <span id="copyright-year">{currentYear}</span> {profileConfig.name}. All Rights Reserved. /
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href={url('rss.xml')}>RSS</a> /
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href={url('sitemap-index.xml')}>Sitemap</a><br>
        本网站使用
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://astro.build">Astro</a> 和
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://github.com/saicaca/fuwari">Fuwari</a>
        项目并二次开发
    </div>
</div>

<script>
  // 一言 API 缓存（避免频繁请求）
  let hitokotoCache: { quote: string; timestamp: number } | null = null;
  const CACHE_DURATION = 5 * 60 * 1000; // 5分钟缓存

  // 获取每日一言
  async function fetchHitokoto(): Promise<string | null> {
    // 检查缓存
    if (hitokotoCache && Date.now() - hitokotoCache.timestamp < CACHE_DURATION) {
      return hitokotoCache.quote;
    }

    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 5000);
      
      const res = await fetch("https://v1.hitokoto.cn?c=i&encode=json", {
        signal: controller.signal
      });
      clearTimeout(timeoutId);
      
      if (!res.ok) throw new Error('API request failed');
      const data = await res.json();
      
      if (data && data.hitokoto) {
        const quote = `"${data.hitokoto}" — ${data.from || "佚名"}`;
        // 更新缓存
        hitokotoCache = { quote, timestamp: Date.now() };
        return quote;
      }
    } catch (e) {
      console.info("每日一言暂时无法获取");
    }
    return null;
  }

  // 更新页脚信息
  async function updateFooter() {
    // 更新运行时间
    const launchDate = new Date("2026-01-02");
    const today = new Date();
    const daysRunning = Math.floor((today.getTime() - launchDate.getTime()) / (1000 * 60 * 60 * 24));
    const runDaysElement = document.getElementById('run-days');
    if (runDaysElement) {
      runDaysElement.textContent = String(daysRunning);
    }

    // 更新一言
    const dailyQuoteElement = document.getElementById('daily-quote');
    if (dailyQuoteElement) {
      const quote = await fetchHitokoto();
      if (quote) {
        dailyQuoteElement.textContent = quote;
      } else {
        // 使用默认句子
        const defaultQuote = dailyQuoteElement.getAttribute('data-default-quote');
        if (defaultQuote) {
          dailyQuoteElement.textContent = defaultQuote;
        }
      }
    }
  }

  // 初始化
  function initFooter() {
    updateFooter();
    
    // 定期更新运行时间
    setInterval(() => {
      const launchDate = new Date("2026-01-02");
      const today = new Date();
      const daysRunning = Math.floor((today.getTime() - launchDate.getTime()) / (1000 * 60 * 60 * 24));
      const runDaysElement = document.getElementById('run-days');
      if (runDaysElement) {
        runDaysElement.textContent = String(daysRunning);
      }
    }, 60000);
  }

  // 页面加载时执行
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFooter);
  } else {
    initFooter();
  }

  // 监听 Swup 页面切换事件
  document.addEventListener('swup:page:view', () => {
    updateFooter();
  });
</script>
